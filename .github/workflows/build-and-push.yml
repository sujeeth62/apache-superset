name: Build and Push

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - push
      version-bump:
        description: 'Version bump type (only used when action is push)'
        required: false
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch

env:
  IMAGE_NAME: sujeeth62/apache-superset
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

jobs:
  build:
    name: Build ${{ github.event.inputs.action || 'test' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ github.event.inputs.action == 'push' || github.event_name == 'push' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Get current version
        id: version
        run: |
          if [ "${{ github.event.inputs.action }}" = "push" ]; then
            # For push action, get version from Docker Hub
            echo "Fetching latest version from Docker Hub..."
            API_RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.IMAGE_NAME }}/tags/?page_size=100")
      
            # Debug: Print API response (without exposing tokens)
            echo "API Response: ${API_RESPONSE:0:200}..."
      
            # Get the latest version tag
            if [ -z "$API_RESPONSE" ]; then
              echo "Warning: Empty response from Docker Hub API, using default version 0.0.0"
              LATEST_TAG="0.0.0"
            else
              LATEST_TAG=$(echo "$API_RESPONSE" | \
              jq -r '.results[] | select(.name | test("^\\d+\\.\\d+\\.\\d+$")) | .name' | \
              sort -V | tail -n 1 || echo "0.0.0")
            fi
      
            # If we still don't have a valid version, default to 0.0.0
            if [[ ! "$LATEST_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Warning: Invalid version format '$LATEST_TAG' from Docker Hub, defaulting to 0.0.0"
            LATEST_TAG="0.0.0"
            fi
            
            echo "Current latest version: $LATEST_TAG"
            
            # Parse version components
            IFS='.' read -r -a VERSION_PARTS <<< "$LATEST_TAG"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Bump version based on input
            case "${{ github.event.inputs.version-bump }}" in
              major)
                NEW_MAJOR=$((MAJOR + 1))
                NEW_VERSION="${NEW_MAJOR}.0.0"
                ;;
              minor)
                NEW_MINOR=$((MINOR + 1))
                NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
                ;;
              patch)
                NEW_PATCH=$((PATCH + 1))
                NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
                ;;
              *)
                # If it's a specific version, use it
                if [[ "${{ github.event.inputs.version-bump }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  NEW_VERSION="${{ github.event.inputs.version-bump }}"
                else
                  echo "Invalid version format. Using patch bump."
                  NEW_PATCH=$((PATCH + 1))
                  NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
                fi
                ;;
            esac
            
            echo "New version: $NEW_VERSION"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            # For test action, use test tag with commit SHA
            echo "version=test-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: ${{ github.event.inputs.action == 'push' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run tests
        if: ${{ github.event.inputs.action != 'push' }}
        run: |
          echo "Running tests for ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          # Add your test commands here, for example:
          # docker run --rm ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} pytest

      - name: Create GitHub Release
        if: ${{ (github.event.inputs.action == 'push' || github.event_name == 'push') && success() }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Version ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
